#!/usr/bin/env node

"use strict";

const path = require("path");
const util = require("util");

const glob = util.promisify(require("glob"));

const { cleanTestFile } = require("./xml-util");

const { cprp, existsInFile, mkdirp, newer } = require("./util");

process.on("unhandledRejection", (err) => {
  // eslint-disable-next-line no-console
  console.log(err);
  process.exit(1);
});

async function convert() {
  const files = await glob("src/tests/!(convert)_test_data/**",
                           { nodir: true });
  return Promise.all(files.map(async (file) => {
    const ext = path.extname(file);
    const destFile = file.replace(/^src/, "lib")
          .substring(0, file.length - ext.length);
    const dest = `${path.join("build/dist/dev", destFile)}_converted.xml`;

    const tei = await existsInFile(file, /http:\/\/www.tei-c.org\/ns\/1.0/);

    if (!await newer(file, dest)) {
      return;
    }

    await mkdirp(path.dirname(dest));
    await (tei ? cleanTestFile(file, dest) : cprp(file, dest));
  }));
}

convert();
