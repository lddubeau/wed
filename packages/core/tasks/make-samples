#!/usr/bin/env node

"use strict";

const glob = require("glob");
const path = require("path");
const log = require("fancy-log");

const { cleanTestFile } = require("./xml-util");

const { newer, copy, existsInFile } = require("./util");

process.on("unhandledRejection", (err) => {
  // eslint-disable-next-line no-console
  console.log(err);
  process.exit(1);
});

Promise.all(glob.sync("sample_documents/*.xml").map(async (sample) => {
  const dest = `build/samples/${path.basename(sample)}`;
  const isNewer = await newer(sample, dest);
  if (!isNewer) {
    log(`Skipping generation of ${dest}`);
    return;
  }

  const needsXSL = await existsInFile(sample, "http://www.tei-c.org/ns/1.0");
  await (needsXSL ? cleanTestFile(sample, dest) : copy(sample, dest));
}));
